---
layout: post
status: publish
published: true
title: yii & utf-8 & BOM - выдача битой капчи

date: '2013-03-26 16:22:00 +0200'

categories:
- bugs
tags:
- yii
- bom
- utf-8
---
<div dir="ltr" style="text-align: left;" trbidi="on">
Встретил очередную проблему, которая завела меня в тупик.</p>
<h4 style="text-align: left;">
Вступление </h4>
<p>После очереного апдейта сайта на yii сторонними программистами - возник вопрос формата: "почему на всех формах перстала отображаться капча?".<br />
Поначалу это вызвало у меня улыбку - наверняка забыли описать экшн "captcha" в функции "filters()" контроллеров, либо для этого экшена нет маршрута.</p>
<p>Прошелся по контроллерам, просмотрел маршруты - все было в порядке.<br />
Ну думаю - наверняка стоит как-либо event-перехватчик -- прошелся по файлом и конфигу - все снова в порядке.</p>
<p>Ну если везде все впорядке - наверняка затерты файлы ядра yii. Сказано - сделано, удалил папку с фреймворком, вместо него залил ту же версию заново. Капча всеравно генерировала битую картинку. :)</p>
<p>
Теперь я решил заняться проблемой серьезно - запустил wireshark, настроил фильтры по хосту/порту и получил TCP пакет изображения.</p>
<div style="text-align: left;">
Каково же было мое удивление когда я увидел в png картинке три первых байта - это были EF BB BF - также известные как bom метка файла в кодировке utf-8.</div>
<h4 style="text-align: left;">
Решение</h4>
<div style="text-align: left;">
Для удаления BOM из php файлов можно воспользоваться небольшим скриптом:<br /></p>
<pre class="prettyprint">for i in `find -name '*.php' -type f`
do
sed -i -e '1s/^xefxbbxbf//' $i
done
</pre>
</div>
<div style="text-align: left;">
<h4 style="text-align: left;">
Вывод</h4>
<p>Прежде чем начать работать с файлами, настройте редактор/ide/etc.</p></div>
</div>
